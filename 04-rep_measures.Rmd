# A repeated measures animal model {#rep_measures}

This tutorial will demonstrate how to run a univariate animal model for a trait with repeated observations using different R packages and example data files provided.

## Scenario and data

### scenario

Since gryphons are iteroparous, multiple observations of reproductive traits are available for some individuals. Here we have repeated measures of lay date (measured in days after January 1) for individual females varying in age from 2 (age of maturation) up until age 6. Not all females lay every year so the number of observations per female is variable. We want to know how repeatable the trait is, and (assuming it is repeatable) how heritable it is.

### Data files

The pedigree file `gryphonped.txt` is that used in the preceding tutorials but we now use a new data file `gryphonRM.txt`. Columns correspond to individual identity (`ANIMAL`), birth year (`BYEAR`), age in years (`AGE`), year of measurement (`YEAR`) and lay date (`LAYDATE`). Each row of the data file corresponds to a single phenotypic observation. Here data are sorted by identity and then age so that the repeated observations on individuals are readily apparent. However this is not a requirement for analysis - data could equally be sorted by some other variable (_e.g._, measurement year) or be in a random order.

```{r, echo=FALSE}
gryphonRM <- read.table("gryphonRM.txt", header=T, na.strings="NA")
gryphonRM$ANIMAL <- as.factor(gryphonRM$ANIMAL)
gryphonRM$BYEAR<-as.factor(gryphonRM$BYEAR)
gryphonRM$AGE<-as.factor(gryphonRM$AGE)
gryphonRM$YEAR<-as.factor(gryphonRM$YEAR)
gryphonRM$LAYDATE<-as.numeric(gryphonRM$LAYDATE)
```

```{r, echo=TRUE, eval=FALSE}
gryphonRM <- read.table("/the/path/to/gryphonRM.txt",
                        header=T, na.strings="NA")

gryphonRM$ANIMAL <- as.factor(gryphonRM$ANIMAL)
gryphonRM$BYEAR <- as.factor(gryphonRM$BYEAR)
gryphonRM$AGE <- as.factor(gryphonRM$AGE)
gryphonRM$YEAR <- as.factor(gryphonRM$YEAR)
gryphonRM$LAYDATE <- as.numeric(gryphonRM$LAYDATE)
```

```{r}
head(gryphonRM)
```

## Asreml-R 4.0

### Estimating repeatability

With repeated measures on individuals it is often of interest, prior to fitting a genetic model, to see how repeatable a trait is. We can estimate the repeatability of a trait as the proportion of phenotypic variance explained by individual identity.

```{r}
modelv <- asreml(fixed = LAYDATE ~ 1,
                 random =~ ANIMAL,
                 residual=~idv(units),
                 data=gryphonRM,
                 na.action = na.method(x="omit", y="omit"))
```
Note that since we want to estimate the amount of variance explained by individual identity (rather than by additive effects), we fit `ANIMAL` as a normal random effect and we don't associate it with the pedigree.

This model partitions the phenotypic variance in `LAYDATE` as follows:
```{r}
summary(modelv)$varcomp
```

Between-individual variance is given by the `ANIMAL` component, while the residual component (`units!units`) represents within-individual variance. Here then the repeatability of the trait can be determined by hand as `r round(summary(modelv)$varcomp[1,1]/(summary(modelv)$varcomp[1,1]+summary(modelv)$varcomp[2,1]),2)` (_i.e._, as `r round(summary(modelv)$varcomp[1,1],3)`/(`r round(summary(modelv)$varcomp[1,1],3)` + `r round(summary(modelv)$varcomp[2,1], 3)`)).

Mean lay date might change with age, so we could ask what the repeatability of lay date is after conditioning on age. This would be done by adding `AGE` into the model as a fixed effect.
```{r}
modelw <- asreml(fixed = LAYDATE ~ AGE,
                 random =~ ANIMAL,
                 residual=~idv(units),
                 data=gryphonRM,
                 na.action = na.method(x="omit", y="omit"))

summary(modelw)$varcomp
```

The repeatability of lay date, after accounting for age effects, is now estimated as `r round(summary(modelw)$varcomp[1,1]/(summary(modelw)$varcomp[1,1]+summary(modelw)$varcomp[2,1]), 2)` (_i.e._, as `r round(summary(modelw)$varcomp[1,1], 3)`/(`r round(summary(modelw)$varcomp[1,1], 3)` + `r round(summary(modelw)$varcomp[2,1], 3)`)). So, just as we saw when estimating $h^2$ in Tutorial 1, the inclusion of fixed effects will alter the estimated effect size if we determine total phenotypic variance as the sum of the variance components. Thus, proper interpretation is vital.

Here age is modelled as a 5-level factor (specified using the function `as.factor()` at the beginning of the analysis). We could equally have fitted it as a continuous variable, in which case, given potential for a late life decline, we would probably also include a quadratic term.

## 4) Partitioning additive and permanent environment effects

Generally we expect that the repeatability will set the upper limit for heritability since, while additive genetic effects will cause among-individual variation, so will other types of effects. Non-additive contributions to fixed among-individual differences are normally referred to as _permanent environment effects_. If a trait has repeated measures then it is necessary to model permanent environment effects in an animal model to prevent upward bias in $V_A$.

To illustrate this fit the animal model:
```{r}
modelx <- asreml(fixed = LAYDATE ~ AGE,
                 random =~ vm(ANIMAL, ainv),
                 residual=~idv(units),
                 data=gryphonRM,
                 na.action = na.method(x="omit", y="omit"))
```

Variance components are almost unchanged:
```{r}
summary.asreml(modelx)$varcomp
```

This suggests that all of the among-individual variance is – rightly or wrongly – being partitioned as $V_A$ here. To instead obtain an unbiased estimate of $V_A$ we need to allow for both additive genetic _and_ non-genetic sources of individual variation. We do this by fitting `ANIMAL` twice, once with a pedigree, and once without a pedigree (using `ide()`).
```{r}
modely <- asreml(fixed = LAYDATE ~ AGE,
                 random =~ vm(ANIMAL, ainv) + ide(ANIMAL),
                 residual=~idv(units),
                 data=gryphonRM,
                 na.action = na.method(x="omit", y="omit"))
summary(modely)$varcomp
```

The estimate of $V_A$ is now much lower since the additive and permanent environment effects are being properly separated. We can estimate $h^2$ and the repeatability from this model:
```{r}
vpredict(modely, h2 ~ V1/(V1+V2+V3))
vpredict(modely, repeatability ~ (V1+V2)/(V1+V2+V3))
```

## 5) Adding additional effects and testing significance

Models of repeated measures can be extended to include other fixed or random effects. For example try including year of measurement (`YEAR`) and birth year (`BYEAR`) as random effects.
```{r}
modelz <- asreml(fixed = LAYDATE ~ AGE,
                 random =~ vm(ANIMAL, ainv) + ide(ANIMAL) +
                 YEAR + BYEAR,
                 residual=~idv(units),
                 data=gryphonRM,
                 na.action = na.method(x="omit", y="omit"))
summary(modelz)$varcomp
```

This model will return additional variance components corresponding to variation in lay dates between years of measurement and between birth cohorts of females. $V_{BYEAR}$ is very low and if you compare this model to a reduced model with BYEAR excluded the log-likelihood remains unchanged.

`YEAR` effects could alternatively be included as fixed effects (try this!). This will reduce $V_R$ and increase the estimates of heritability and repeatability, which must now be interpreted as proportions of phenotypic variance after conditioning on both age and year of measurement effects.


## MCMCglmm

### Estimating repeatability

With repeated measures on individuals it is often of interest, prior to fitting a genetic
model, to see how repeatable a trait is. We can estimate the repeatability of a trait as the
proportion of phenotypic variance explained by individual identity using the commands
below
>
>
+
>
+
>
p.var <- var(DataRM$LAYDATE, na.rm = TRUE)
prior3.1 <- list(G = list(G1 = list(V = 1, nu = 0.002)), R = list(V = 1,
nu = 0.002))
model3.1 <- MCMCglmm(LAYDATE ~ 1, random = ~ID, data = DataRM,
prior = prior3.1, verbose = FALSE)
posterior.mode(model3.1$VCV)

ID
units
11.45322 21.14320
Note the use of the new ID factor that we created in the previous section.
Between-individual variance is given by the ID component, while the residual compo-
nent (Variance) therefore represents within-individual variance. Here then the repeata-
bility of the trait can be determined by as 0.353 (i.e., 11.4532/(11.4532+21.1432). Given
that we set up the simulation such that mean lay date changes with age (initially increas-
ing to age 5 before a late life decline) we might ask what the repeatability of lay date is
after conditioning on age effect. This would be done by adding age into the model as a
fixed effect.
>
+
>
>
>
model3.2 <- MCMCglmm(LAYDATE ~ AGE, random = ~ID, data = DataRM,
prior = prior3.1, verbose = FALSE)
plot(model3.2$Sol)
plot(model3.2$VCV)
posterior.mode(model3.2$VCV)
ID
units
12.63794 16.46501
Note that the random effect structure has remained unchaged, and so we have not
modified the prior between models 3.1 and 3.2.
So that the repeatability of laydate, after accounting for age effects, is now estimated
as 0.445 (i.e., 12.6379/(12.6379+16.465). So, just as we saw when estimating h 2 in tutorial
1, the inclusion of fixed effects will alter the estimated effect size if we determine total
phenotypic variance as the sum of the variance components. Thus, proper interpretation
is vital.
Here age is modelled as a 5 level factor (see the convertion of age to a factor in section
3.2). We could equally have fitted it as a continuous variable instead in which case, given
the late life decline, we would probably also include a quadratic term.

## Partitioning additive and permanent environment effects

Generally we expect that the repeatability will set the upper limit for heritability since,
while additive genetic effects will cause among-individual variation, so will other types
of effect. Non-additive contributions to fixed among-individual differences are normally
referred to as ‘permanent environment effects’, although ‘non-heritable effects’ that are
consistent within individuals may be a better way to think of modelling this effect. If a
trait has repeated measures then it is necessary to model permanent environment effects
in an animal model to prevent upward bias in V A . To illustrate this fit the animal model
> model3.3 <- MCMCglmm(LAYDATE ~ 1 + AGE, random = ~animal, pedigree = Ped,
+
data = DataRM, prior = prior3.1, verbose = FALSE)
> posterior.mode(model3.3$VCV)
animal
units
13.67353 16.92081
20


This suggests that all of the among-individual variance is - rightly or wrongly - being
partitioned as V A here. In fact here the partition is wrong since the simulation included
both additive genetic effects and additional fixed heterogeneity that was not associated
with the pedigree structure (i.e. permanent environment effects). An more appropriate
estimate of V A is given by the model:
>
>
+
>
+
>
p.var <- var(DataRM$LAYDATE, na.rm = TRUE)
prior3.4 <- list(G = list(G1 = list(V = 1, n = 0.002), G2 = list(V = 1,
n = 0.002)), R = list(V = 1, n = 0.002))
model3.4 <- MCMCglmm(LAYDATE ~ 1 + AGE, random = ~animal + ID,
pedigree = Ped, data = DataRM, prior = prior3.4, verbose = FALSE)
posterior.mode(model3.4$VCV)
animal
5.123798
ID
units
7.056109 16.242474
The estimate of V A is now much lower (reduced from 13.6735 to 5.1238) since the ad-
ditive and permanent environment effects are being properly separated. We could obtain
estimates of h 2 and of the repeatability from this model using the following commands:
> model3.4.VP <- model3.4$VCV[, "animal"] + model3.4$VCV[, "ID"] +
+
model3.4$VCV[, "units"]
> model3.4.IDplusVA <- model3.4$VCV[, "animal"] + model3.4$VCV[,
+
"ID"]
> posterior.mode(model3.4.IDplusVA/model3.4.VP)
var1
0.4416178
> posterior.mode(model3.4$VCV[, "animal"]/model3.4.VP)
var1
0.1402542

## Adding additional effects and testing significance

Models of repeated measures can be extended to include other fixed or random effects.
For example try including year of measurement (YEAR).
>
>
+
+
>
+
+
>
p.var <- var(DataRM$LAYDATE, na.rm = TRUE)
prior3.5 <- list(G = list(G1 = list(V = 1, n = 0.002), G2 = list(V = 1,
n = 0.002), G3 = list(V = 1, n = 0.002), G4 = list(V = 1,
n = 0.002)), R = list(V = 1, n = 0.002))
model3.5 <- MCMCglmm(LAYDATE ~ 1 + AGE, random = ~animal + ID +
YEAR + BYEAR, pedigree = Ped, data = DataRM, prior = prior3.5,
verbose = FALSE)
posterior.mode(model3.5$VCV)


This model will return additional variance components corresponding to year of mea-
surement effects and birth year (of the female effects). The latter were not simulated as
should be apparent from the parameter estimate (and by the support interval derivable
from the posterior distribution and from DIC-based comparison of model3.5 and a model
from which the birth year term had been eliminated, see tutorial 1). However, YEAR ef-
fects were simulated as should be apparent from the from the modal estimate and from
the support interval (try this yourself using HPDinterval()) and this could be formally
confirmed by comparison of DIC.
YEAR effects could alternatively be included as fixed effects (try this, you should be
able to handle the new prior specification at this point). Since we simulated large year
of measurement effects this treatment will reduce V R and increase the the estimates of
heritability and repeatability which must now be interpreted as proportions of phenotypic
variance after conditioning on both age and year of measurement effects.
