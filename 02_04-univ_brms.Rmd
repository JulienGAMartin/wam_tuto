## brms

### Running the model

First we need to load the `brms` library:
```{r}
library(brms)
```
<!-- C1 May be add a sentence about brms and its link to stan ? -->
To be able to fit an animal model, brms needs the relationship matrix (and not its inverse as in other softwares).
This can be estimated using the `nadiv` package
<!-- C2 May be add a sentence about nadiv? -->

```{r}
Amat <- as.matrix(nadiv::makeA(gryphonped))
```
We are now ready to specify our first model:
The structure of a bmrs model is similar to `lme4`, the random effect is added to the model with the term `(1 | gr(animal, cov = Amat)`. (<!-- C3 more explanation aboout this structure becaue is not intuive for other biologists-->)

```{r eval = params$fit_all}
brms_m1.1 <- brm(
  bwt ~ 1 + (1 | gr(animal, cov = Amat)),
  data = gryphon,
  data2 = list(Amat = Amat),
  family = gaussian(),
  chains = 2, cores = 2, iter = 1000
)
save(brms_m1.1, file = "data/brms_m1_1.rda")
```

The result of the long model calculation is save in a spare file `brms_m1_1.rda"`.
reloading it, we can examine (or directly using the model) the variance estimate and their distributions
It is also possible to calcule the heritability using xxx

```{r}
load("data/brms_m1_1.rda")
summary(brms_m1.1)
plot(brms_m1.1)

v_animal <- (VarCorr(brms_m1.1, summary = FALSE)$animal$sd)^2
v_r <- (VarCorr(brms_m1.1, summary = FALSE)$residual$sd)^2
h.bwt <- as.mcmc(v_animal / (v_animal + v_r))
summary(h.bwt)
```

<!-- C4 autocorrelation diagnostic -->



### Adding fixed effects

To add effects to a univariate model we simply modify the fixed effect portion of the model specification:

```{r eval = params$fit_all}
brms_m1.2 <- brm(
  bwt ~ 1 + sex + (1 | gr(animal, cov = Amat)),
  data = gryphon,
  data2 = list(Amat = Amat),
  family = gaussian(),
  chains = 2, cores = 2, iter = 1000
)

save(brms_m1.2, file = "data/brms_m1_2.rda")
```

```{r}
load("data/brms_m1_2.rda")
summary(brms_m1.2)
plot(brms_m1.2)


summary(brms_m1.2)$fixed
summary(brms_m1.2)$random
```

### Adding random effects

This is done by simply modifying the model statement in the same way, but requires addition of a prior for the new random effect. For instance, we can fit an effect of birth year:


```{r, eval = params$fit_all}
brms_m1.3 <- brm(
  bwt ~ 1 + sex + (1 | gr(animal, cov = Amat)) + (1 | byear) + (1 | mother),
  data = gryphon,
  data2 = list(Amat = Amat),
  family = gaussian(),
  chains = 2, cores = 2, iter = 1000
)
save(brms_m1.3, file = "data/brms_m1_3.rda")
```

```{r}
load("data/brms_m1_3.rda")
summary(brms_m1.3)
plot(brms_m1.3, ask = FALSE, N = 3)
```


### Testing significance of variance components

<!--C5 how to compare models?  DIC or Ci of estimate or other test  -->


### Further partitioning of the variance

Depending of the research question and the presence of different group within the dataset, MCMCglmm allowed to partition the variance at different level. For the example, we can partition the additive genetic and residual variance between SEXE (male and female) to estimate the sex-specific heritability 

 <!-- C6 need to check the code  I never partition a random effect with lme4 + need to apply it to the residual level too, more too do here -->

```{r eval = params$fit_all}
brms_m1.4 <- brm(
  bwt ~ 1 + sex + (1 | gr(animal, cov = Amat)) + (1 | byear) + (1 | mother),
  data = gryphon,
  data2 = list(Amat = Amat),
  family = gaussian(),
  chains = 2, cores = 2, iter = 1000
)
save(brms_m1.4, file = "data/brms_m1_4.rda")
```

```{r}
load("data/brms_m1_4.rda")
summary(brms_m1.4)
plot(brms_m1.4, ask = FALSE, N = 3)
```


### Modification of model parameter

### Covariance between two random effects
